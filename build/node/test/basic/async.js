"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.async = void 0;
var Time = _interopRequireWildcard(require("@dashkite/joy/time"));
var h = _interopRequireWildcard(require("../helpers.js"));
function _getRequireWildcardCache(e) { if ("function" != typeof WeakMap) return null; var r = new WeakMap(), t = new WeakMap(); return (_getRequireWildcardCache = function (e) { return e ? t : r; })(e); }
function _interopRequireWildcard(e, r) { if (!r && e && e.__esModule) return e; if (null === e || "object" != typeof e && "function" != typeof e) return { default: e }; var t = _getRequireWildcardCache(r); if (t && t.has(e)) return t.get(e); var n = { __proto__: null }, a = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var u in e) if ("default" !== u && Object.prototype.hasOwnProperty.call(e, u)) { var i = a ? Object.getOwnPropertyDescriptor(e, u) : null; i && (i.get || i.set) ? Object.defineProperty(n, u, i) : n[u] = e[u]; } return n.default = e, t && t.set(e, n), n; }
var test;
exports.async = test = async function ($) {
  var $halt, $start, graph, talos;
  ({
    $start,
    $halt
  } = $.lib);
  graph = null;
  talos = null;
  return [await h.test("define graph", h.target("basic-async", function () {
    return graph = $.lib.Graph.create({
      [$start]: {
        edges: [{
          accept: true,
          run: null,
          move: "A"
        }]
      },
      A: {
        edges: [{
          accept: "go",
          run: async function (talos) {
            await Time.sleep(1);
            return talos.context.message = "made it to A, going to B";
          },
          move: "B"
        }]
      },
      B: {
        edges: [{
          accept: false,
          run: async function (talos) {
            await Time.sleep(1);
            return talos.context.message = "this overwrite shouldn't happen";
          },
          move: $halt
        }, {
          accept: true,
          run: async function () {
            return await Time.sleep(1);
          },
          move: $halt
        }]
      }
    });
  })), await h.test("define talos", h.target("basic-async", function () {
    return talos = $.lib.Talos.create();
  })), await h.test("run talos", h.target("basic-async", async function () {
    h.assert.equal($start, talos.state);
    await $.lib.stepAsync(graph, talos, null);
    h.assert.equal("A", talos.state);
    await $.lib.stepAsync(graph, talos, "go");
    h.assert.equal("B", talos.state);
    h.assert.equal("made it to A, going to B", talos.context.message);
    await $.lib.stepAsync(graph, talos, "go");
    h.assert(talos.success);
    return h.assert.equal("made it to A, going to B", talos.context.message);
  }))];
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRlc3QvYmFzaWMvYXN5bmMuY29mZmVlIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLElBQUEsSUFBQSxHQUFBLHVCQUFBLENBQUEsT0FBQTtBQUFBLElBQUEsQ0FBQSxHQUFBLHVCQUFBLENBQUEsT0FBQTtBQUFBLFNBQUEseUJBQUEsQ0FBQSw2QkFBQSxPQUFBLG1CQUFBLENBQUEsT0FBQSxPQUFBLElBQUEsQ0FBQSxPQUFBLE9BQUEsWUFBQSx3QkFBQSxZQUFBLENBQUEsQ0FBQSxXQUFBLENBQUEsR0FBQSxDQUFBLEdBQUEsQ0FBQSxLQUFBLENBQUE7QUFBQSxTQUFBLHdCQUFBLENBQUEsRUFBQSxDQUFBLFNBQUEsQ0FBQSxJQUFBLENBQUEsSUFBQSxDQUFBLENBQUEsVUFBQSxTQUFBLENBQUEsZUFBQSxDQUFBLHVCQUFBLENBQUEseUJBQUEsQ0FBQSxXQUFBLE9BQUEsRUFBQSxDQUFBLFFBQUEsQ0FBQSxHQUFBLHdCQUFBLENBQUEsQ0FBQSxPQUFBLENBQUEsSUFBQSxDQUFBLENBQUEsR0FBQSxDQUFBLENBQUEsVUFBQSxDQUFBLENBQUEsR0FBQSxDQUFBLENBQUEsT0FBQSxDQUFBLEtBQUEsU0FBQSxVQUFBLENBQUEsR0FBQSxNQUFBLENBQUEsY0FBQSxJQUFBLE1BQUEsQ0FBQSx3QkFBQSxXQUFBLENBQUEsSUFBQSxDQUFBLG9CQUFBLENBQUEsSUFBQSxNQUFBLENBQUEsU0FBQSxDQUFBLGNBQUEsQ0FBQSxJQUFBLENBQUEsQ0FBQSxFQUFBLENBQUEsU0FBQSxDQUFBLEdBQUEsQ0FBQSxHQUFBLE1BQUEsQ0FBQSx3QkFBQSxDQUFBLENBQUEsRUFBQSxDQUFBLFVBQUEsQ0FBQSxLQUFBLENBQUEsQ0FBQSxHQUFBLElBQUEsQ0FBQSxDQUFBLEdBQUEsSUFBQSxNQUFBLENBQUEsY0FBQSxDQUFBLENBQUEsRUFBQSxDQUFBLEVBQUEsQ0FBQSxJQUFBLENBQUEsQ0FBQSxDQUFBLElBQUEsQ0FBQSxDQUFBLENBQUEsWUFBQSxDQUFBLENB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QyxPQUFPLENBQUMsT0FBekQsQ0FBQTtJQUVBLE1BQU0sQ0FBQyxDQUFDLEdBQUcsQ0FBQyxTQUFOLENBQWdCLEtBQWhCLEVBQXVCLEtBQXZCLEVBQThCLElBQTlCLENBQUE7SUFDTixDQUFDLENBQUMsTUFBRixDQUFTLEtBQUssQ0FBQyxPQUFmLENBQUE7V0FDQSxDQUFDLENBQUMsTUFBTSxDQUFDLEtBQVQsQ0FBZSwwQkFBZixFQUEyQyxLQUFLLENBQUMsT0FBTyxDQUFDLE9BQXpELENBQUE7RUFaZ0QsQ0FBeEIsQ0FBcEIsQ0FqQ1IsQztBQUxLLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBUaW1lIGZyb20gXCJAZGFzaGtpdGUvam95L3RpbWVcIlxuaW1wb3J0ICogYXMgaCBmcm9tIFwiLi4vaGVscGVyc1wiXG5cbnRlc3QgPSAoICQgKSAtPlxuICB7ICRzdGFydCwgJGhhbHQgfSA9ICQubGliXG4gIGdyYXBoID0gbnVsbFxuICB0YWxvcyA9IG51bGxcblxuICBbXG4gICAgYXdhaXQgaC50ZXN0IFwiZGVmaW5lIGdyYXBoXCIsIGgudGFyZ2V0IFwiYmFzaWMtYXN5bmNcIiwgLT5cbiAgICAgIGdyYXBoID0gJC5saWIuR3JhcGguY3JlYXRlXG4gICAgICAgIFsgJHN0YXJ0IF06XG4gICAgICAgICAgZWRnZXM6IFtcbiAgICAgICAgICAgIGFjY2VwdDogdHJ1ZVxuICAgICAgICAgICAgcnVuOiBudWxsXG4gICAgICAgICAgICBtb3ZlOiBcIkFcIlxuICAgICAgICAgIF1cbiAgICAgICAgQTpcbiAgICAgICAgICBlZGdlczogW1xuICAgICAgICAgICAgYWNjZXB0OiBcImdvXCJcbiAgICAgICAgICAgIHJ1bjogKCB0YWxvcyApIC0+XG4gICAgICAgICAgICAgIGF3YWl0IFRpbWUuc2xlZXAgMVxuICAgICAgICAgICAgICB0YWxvcy5jb250ZXh0Lm1lc3NhZ2UgPSBcIm1hZGUgaXQgdG8gQSwgZ29pbmcgdG8gQlwiXG4gICAgICAgICAgICBtb3ZlOiBcIkJcIlxuICAgICAgICAgIF1cbiAgICAgICAgQjpcbiAgICAgICAgICBlZGdlczogW1xuICAgICAgICAgICAgICBhY2NlcHQ6IGZhbHNlXG4gICAgICAgICAgICAgIHJ1bjogKCB0YWxvcyApIC0+XG4gICAgICAgICAgICAgICAgYXdhaXQgVGltZS5zbGVlcCAxXG4gICAgICAgICAgICAgICAgdGFsb3MuY29udGV4dC5tZXNzYWdlID0gXCJ0aGlzIG92ZXJ3cml0ZSBzaG91bGRuJ3QgaGFwcGVuXCJcbiAgICAgICAgICAgICAgbW92ZTogJGhhbHRcbiAgICAgICAgICAgICxcbiAgICAgICAgICAgICAgYWNjZXB0OiB0cnVlXG4gICAgICAgICAgICAgIHJ1bjogLT4gYXdhaXQgVGltZS5zbGVlcCAxXG4gICAgICAgICAgICAgIG1vdmU6ICRoYWx0XG4gICAgICAgICAgXVxuICAgIFxuICAgIGF3YWl0IGgudGVzdCBcImRlZmluZSB0YWxvc1wiLCBoLnRhcmdldCBcImJhc2ljLWFzeW5jXCIsIC0+XG4gICAgICB0YWxvcyA9ICQubGliLlRhbG9zLmNyZWF0ZSgpXG5cbiAgICBhd2FpdCBoLnRlc3QgXCJydW4gdGFsb3NcIiwgaC50YXJnZXQgXCJiYXNpYy1hc3luY1wiLCAtPlxuICAgICAgaC5hc3NlcnQuZXF1YWwgJHN0YXJ0LCB0YWxvcy5zdGF0ZVxuICAgICAgXG4gICAgICBhd2FpdCAkLmxpYi5zdGVwQXN5bmMgZ3JhcGgsIHRhbG9zLCBudWxsXG4gICAgICBoLmFzc2VydC5lcXVhbCBcIkFcIiwgdGFsb3Muc3RhdGVcblxuICAgICAgYXdhaXQgJC5saWIuc3RlcEFzeW5jIGdyYXBoLCB0YWxvcywgXCJnb1wiXG4gICAgICBoLmFzc2VydC5lcXVhbCBcIkJcIiwgdGFsb3Muc3RhdGVcbiAgICAgIGguYXNzZXJ0LmVxdWFsIFwibWFkZSBpdCB0byBBLCBnb2luZyB0byBCXCIsIHRhbG9zLmNvbnRleHQubWVzc2FnZVxuXG4gICAgICBhd2FpdCAkLmxpYi5zdGVwQXN5bmMgZ3JhcGgsIHRhbG9zLCBcImdvXCJcbiAgICAgIGguYXNzZXJ0IHRhbG9zLnN1Y2Nlc3NcbiAgICAgIGguYXNzZXJ0LmVxdWFsIFwibWFkZSBpdCB0byBBLCBnb2luZyB0byBCXCIsIHRhbG9zLmNvbnRleHQubWVzc2FnZVxuICBdXG5cbmV4cG9ydCB7IHRlc3QgYXMgYXN5bmMgfSJdLCJzb3VyY2VSb290IjoiIn0=
//# sourceURL=test/basic/async.coffee