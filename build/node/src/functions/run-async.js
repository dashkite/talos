"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.runAsync = void 0;
var Fn = _interopRequireWildcard(require("@dashkite/joy/function"));
var Type = _interopRequireWildcard(require("@dashkite/joy/type"));
var _index = require("../containers/index.js");
var Error = _interopRequireWildcard(require("../containers/errors.js"));
function _getRequireWildcardCache(e) { if ("function" != typeof WeakMap) return null; var r = new WeakMap(), t = new WeakMap(); return (_getRequireWildcardCache = function (e) { return e ? t : r; })(e); }
function _interopRequireWildcard(e, r) { if (!r && e && e.__esModule) return e; if (null === e || "object" != typeof e && "function" != typeof e) return { default: e }; var t = _getRequireWildcardCache(r); if (t && t.has(e)) return t.get(e); var n = { __proto__: null }, a = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var u in e) if ("default" !== u && Object.prototype.hasOwnProperty.call(e, u)) { var i = a ? Object.getOwnPropertyDescriptor(e, u) : null; i && (i.get || i.set) ? Object.defineProperty(n, u, i) : n[u] = e[u]; } return n.default = e, t && t.set(e, n), n; }
var runAsync;
exports.runAsync = runAsync = Fn.curry(Fn.rtee(async function (graph, talos) {
  var error, vertex;
  if (!_index.Graph.isType(graph)) {
    throw new Error("runSync: graph instance is invalid");
  }
  if (!_index.Talos.isType(talos)) {
    throw new Error("runSync: talos instance is invalid");
  }
  while (true) {
    if (talos.halted) {
      break;
    }
    vertex = await graph.selectAsync(talos);
    if (vertex == null) {
      talos.error = Error.UnknownState.create();
      talos.halt();
      continue;
    }
    if (vertex.action != null) {
      try {
        await vertex.action(talos, vertex);
      } catch (error1) {
        error = error1;
        talos.error = Error.ActionError.create({
          error
        });
        talos.halt();
        continue;
      }
    }
    if (Type.isString(vertex.next)) {
      talos.state = vertex.next;
    } else if (Type.isSymbol(vertex.next)) {
      talos.state = vertex.next;
    } else if (Type.isFunction(vertex.next)) {
      try {
        talos.state = await vertex.next(talos, vertex);
      } catch (error1) {
        error = error1;
        talos.error = Error.NextError.create({
          error
        });
        talos.halt();
        continue;
      }
    } else {
      talos.error = Error.UnknownNext.create({
        vertex
      });
      talos.halt();
      continue;
    }
  }
  return talos;
}));
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNyYy9mdW5jdGlvbnMvcnVuLWFzeW5jLmNvZmZlZSJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQSxJQUFBLEVBQUEsR0FBQSx1QkFBQSxDQUFBLE9BQUE7QUFDQSxJQUFBLElBQUEsR0FBQSx1QkFBQSxDQUFBLE9BQUE7QUFBQSxJQUFBLE1BQUEsR0FBQSxPQUFBO0FBQUEsSUFBQSxLQUFBLEdBQUEsdUJBQUEsQ0FBQSxPQUFBO0FBQUEsU0FBQSx5QkFBQSxDQUFBLDZCQUFBLE9BQUEsbUJBQUEsQ0FBQSxPQUFBLE9BQUEsSUFBQSxDQUFBLE9BQUEsT0FBQSxZQUFBLHdCQUFBLFlBQUEsQ0FBQSxDQUFBLFdBQUEsQ0FBQSxHQUFBLENBQUEsR0FBQSxDQUFBLEtBQUEsQ0FBQTtBQUFBLFNBQUEsd0JBQUEsQ0FBQSxFQUFBLENBQUEsU0FBQSxDQUFBLElBQUEsQ0FBQSxJQUFBLENBQUEsQ0FBQSxVQUFBLFNBQUEsQ0FBQSxlQUFBLENBQUEsdUJBQUEsQ0FBQSx5QkFBQSxDQUFBLFdBQUEsT0FBQSxFQUFBLENBQUEsUUFBQSxDQUFBLEdBQUEsd0JBQUEsQ0FBQSxDQUFBLE9BQUEsQ0FBQSxJQUFBLENBQUEsQ0FBQSxHQUFBLENBQUEsQ0FBQSxVQUFBLENBQUEsQ0FBQSxHQUFBLENBQUEsQ0FBQSxPQUFBLENBQUEsS0FBQSxTQUFBLFVBQUEsQ0FBQSxHQUFBLE1BQUEsQ0FBQSxjQUFBLElBQUEsTUFBQSxDQUFBLHdCQUFBLFdBQUEsQ0FBQSxJQUFBLENBQUEsb0JBQUEsQ0FBQSxJQUFBLE1BQUEsQ0FBQSxTQUFBLENBQUEsY0FBQSxDQUFBLElBQUEsQ0FBQSxDQUFBLEVBQUEsQ0FBQSxTQUFBLENBQUEsR0FBQSxDQUFBLEdBQUEsTUFBQSxDQUFBLHdCQUFBLENBQUEsQ0FBQSxFQUFBLENBQUEsVUFBQSxDQUFBLEtBQUEsQ0FBQSxDQUFBLEdBQUEsSUFBQSxDQUFBLENBQUEsR0FBQSxJQUFBLE1BQUEsQ0FBQSxjQUFBLENBQUEsQ0FBQSxFQUFBLENBQUEsRUFBQSxDQUFBLElBQUEsQ0FBQSxDQUFBLENBQUEsSUFBQSxDQUFBLENBQUEsQ0FBQSxZQUFBLENBQUEsQ0FBQSxPQUFBLEdBQUEsQ0FBQSxFQUFBLENBQUEsSUFBQSxDQUFBLENBQUEsR0FBQSxDQUFBLENBQUEsRUFBQSxDQUFBLEdBQUEsQ0FBQTtBQURBLElBQUEsUUFBQTtBQU1BLE9BQUEsQ0FBQSxRQUFBLEdBQUEsUUFBQSxHQUFXLEVBQUUsQ0FBQyxLQUFILENBQVMsRUFBRSxDQUFDLElBQUgsQ0FBUSxnQkFBRSxLQUFGLEVBQVMsS0FBVCxFQUFBO0VBQzVCLElBQUEsS0FBQSxFQUFBLE1BQUE7RUFBRSxJQUFHLENBQUUsWUFBSyxDQUFDLE1BQU4sQ0FBYSxLQUFiLENBQUwsRUFBQTtJQUNFLE1BQU0sSUFBSSxLQUFKLENBQVUsb0NBQVYsQ0FEUjs7RUFHQSxJQUFHLENBQUUsWUFBSyxDQUFDLE1BQU4sQ0FBYSxLQUFiLENBQUwsRUFBQTtJQUNFLE1BQU0sSUFBSSxLQUFKLENBQVUsb0NBQVYsQ0FEUjs7RUFJQSxPQUFBLElBQUEsRUFBQTtJQUNFLElBQUcsS0FBSyxDQUFDLE1BQVQsRUFBQTtNQUFBOztJQUdBLE1BQUEsR0FBUyxNQUFNLEtBQUssQ0FBQyxXQUFOLENBQWtCLEtBQXhCLENBQUE7SUFDVCxJQUFJLE1BQUEsSUFBQSxJQUFKLEVBQUE7TUFDRSxLQUFLLENBQUMsS0FBTixHQUFjLEtBQUssQ0FBQyxZQUFZLENBQUMsTUFBbkIsQ0FBQSxDQUFBO01BQ2QsS0FBSyxDQUFDLElBQU4sQ0FBQSxDQUFBO01BRkY7O0lBS0EsSUFBRyxNQUFBLENBQUEsTUFBQSxJQUFBLElBQUgsRUFBQTtNQUNFLElBQUE7UUFDRSxNQUFNLE1BQU0sQ0FBQyxNQUFQLENBQWMsS0FBZCxFQUFxQixNQUFyQixDQURSO09BRUEsQ0FBQSxPQUFBLE1BQUEsRUFBQTtRQUFNLEtBQUEsR0FBQSxNQUFBO1FBQ0osS0FBSyxDQUFDLEtBQU4sR0FBYyxLQUFLLENBQUMsV0FBVyxDQUFDLE1BQWxCLENBQXlCO1VBQUU7UUFBRixDQUF6QixDQUFBO1FBQ2QsS0FBSyxDQUFDLElBQU4sQ0FBQSxDQUFBO1FBRkY7TUFIRjs7SUFRQSxJQUFHLElBQUksQ0FBQyxRQUFMLENBQWMsTUFBTSxDQUFDLElBQXJCLENBQUgsRUFBQTtNQUNFLEtBQUssQ0FBQyxLQUFOLEdBQWMsTUFBTSxDQUFDLElBRHZCO0tBQUEsTUFFSyxJQUFHLElBQUksQ0FBQyxRQUFMLENBQWMsTUFBTSxDQUFDLElBQXJCLENBQUgsRUFBQTtNQUNILEtBQUssQ0FBQyxLQUFOLEdBQWMsTUFBTSxDQUFDLElBRGxCO0tBQUEsTUFFQSxJQUFHLElBQUksQ0FBQyxVQUFMLENBQWdCLE1BQU0sQ0FBQyxJQUF2QixDQUFILEVBQUE7TUFDSCxJQUFBO1FBQ0UsS0FBSyxDQUFDLEtBQU4sR0FBYyxNQUFNLE1BQU0sQ0FBQyxJQUFQLENBQVksS0FBWixFQUFtQixNQUF6QixDQURoQjtPQUVBLENBQUEsT0FBQSxNQUFBLEVBQUE7UUFBTSxLQUFBLEdBQUEsTUFBQTtRQUNKLEtBQUssQ0FBQyxLQUFOLEdBQWMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxNQUFoQixDQUF1QjtVQUFFO1FBQUYsQ0FBdkIsQ0FBQTtRQUNkLEtBQUssQ0FBQyxJQUFOLENBQUEsQ0FBQTtRQUZGO01BSEc7S0FBQSxNQUFBO01BUUgsS0FBSyxDQUFDLEtBQU4sR0FBYyxLQUFLLENBQUMsV0FBVyxDQUFDLE1BQWxCLENBQXlCO1FBQUU7TUFBRixDQUF6QixDQUFBO01BQ2QsS0FBSyxDQUFDLElBQU4sQ0FBQSxDQUFBO01BVEc7O0VBdEJQO1NBbUNBLEtBQUE7QUEzQzBCLENBQVIsQ0FBVCxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgRm4gZnJvbSBcIkBkYXNoa2l0ZS9qb3kvZnVuY3Rpb25cIlxuaW1wb3J0ICogYXMgVHlwZSBmcm9tIFwiQGRhc2hraXRlL2pveS90eXBlXCJcbmltcG9ydCB7IEdyYXBoLCBWZXJ0ZXgsIFRhbG9zIH0gZnJvbSBcIi4uL2NvbnRhaW5lcnNcIlxuaW1wb3J0ICogYXMgRXJyb3IgZnJvbSBcIi4uL2NvbnRhaW5lcnMvZXJyb3JzXCJcblxuXG5ydW5Bc3luYyA9IEZuLmN1cnJ5IEZuLnJ0ZWUgKCBncmFwaCwgdGFsb3MgKSAtPlxuICBpZiAhIEdyYXBoLmlzVHlwZSBncmFwaFxuICAgIHRocm93IG5ldyBFcnJvciBcInJ1blN5bmM6IGdyYXBoIGluc3RhbmNlIGlzIGludmFsaWRcIlxuXG4gIGlmICEgVGFsb3MuaXNUeXBlIHRhbG9zXG4gICAgdGhyb3cgbmV3IEVycm9yIFwicnVuU3luYzogdGFsb3MgaW5zdGFuY2UgaXMgaW52YWxpZFwiXG5cblxuICBsb29wXG4gICAgaWYgdGFsb3MuaGFsdGVkXG4gICAgICBicmVha1xuXG4gICAgdmVydGV4ID0gYXdhaXQgZ3JhcGguc2VsZWN0QXN5bmMgdGFsb3NcbiAgICBpZiAhdmVydGV4P1xuICAgICAgdGFsb3MuZXJyb3IgPSBFcnJvci5Vbmtub3duU3RhdGUuY3JlYXRlKClcbiAgICAgIHRhbG9zLmhhbHQoKVxuICAgICAgY29udGludWVcbiAgICBcbiAgICBpZiB2ZXJ0ZXguYWN0aW9uP1xuICAgICAgdHJ5XG4gICAgICAgIGF3YWl0IHZlcnRleC5hY3Rpb24gdGFsb3MsIHZlcnRleFxuICAgICAgY2F0Y2ggZXJyb3JcbiAgICAgICAgdGFsb3MuZXJyb3IgPSBFcnJvci5BY3Rpb25FcnJvci5jcmVhdGUgeyBlcnJvciB9XG4gICAgICAgIHRhbG9zLmhhbHQoKVxuICAgICAgICBjb250aW51ZVxuXG4gICAgaWYgVHlwZS5pc1N0cmluZyB2ZXJ0ZXgubmV4dFxuICAgICAgdGFsb3Muc3RhdGUgPSB2ZXJ0ZXgubmV4dFxuICAgIGVsc2UgaWYgVHlwZS5pc1N5bWJvbCB2ZXJ0ZXgubmV4dFxuICAgICAgdGFsb3Muc3RhdGUgPSB2ZXJ0ZXgubmV4dFxuICAgIGVsc2UgaWYgVHlwZS5pc0Z1bmN0aW9uIHZlcnRleC5uZXh0XG4gICAgICB0cnlcbiAgICAgICAgdGFsb3Muc3RhdGUgPSBhd2FpdCB2ZXJ0ZXgubmV4dCB0YWxvcywgdmVydGV4XG4gICAgICBjYXRjaCBlcnJvclxuICAgICAgICB0YWxvcy5lcnJvciA9IEVycm9yLk5leHRFcnJvci5jcmVhdGUgeyBlcnJvciB9XG4gICAgICAgIHRhbG9zLmhhbHQoKVxuICAgICAgICBjb250aW51ZVxuICAgIGVsc2VcbiAgICAgIHRhbG9zLmVycm9yID0gRXJyb3IuVW5rbm93bk5leHQuY3JlYXRlIHsgdmVydGV4IH1cbiAgICAgIHRhbG9zLmhhbHQoKVxuICAgICAgY29udGludWVcblxuXG4gIHRhbG9zXG5cblxuZXhwb3J0IHtcbiAgcnVuQXN5bmNcbn0iXSwic291cmNlUm9vdCI6IiJ9
//# sourceURL=src/functions/run-async.coffee