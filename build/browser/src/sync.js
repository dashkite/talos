var Step, build, pipe, run, start;
import { generic } from "@dashkite/joy/generic";
import * as Type from "@dashkite/joy/type";
import log from "@dashkite/kaiko";
import { Machine } from "./machine";
import { Talos } from "./talos";
Step = {
    matchVertex: function(talos) {
        var vertex;
        vertex = talos.machine.graph[talos.state];
        if (vertex == null) {
            talos.catch(new Error("talos state is not in machine graph"));
        }
        return vertex;
    },
    matchEdge: function(vertex, talos, event) {
        var edge, error, i, len, ref;
        ref = vertex.edges;
        for(i = 0, len = ref.length; i < len; i++){
            edge = ref[i];
            try {
                if (edge.when(talos, event) === true) {
                    return edge;
                }
            } catch (error1) {
                error = error1;
                return talos.catch(error);
            }
        }
        return talos.catch(new Error("no matching when condition"));
    },
    run: function(edge, talos, event) {
        var error;
        if (edge.run != null) {
            try {
                return edge.run(talos, event);
            } catch (error1) {
                error = error1;
                return talos.catch(error);
            }
        }
    },
    move: function(edge, talos, event) {
        var error;
        try {
            return edge.move(talos, event);
        } catch (error1) {
            error = error1;
            return talos.catch(error);
        }
    },
    step: function(talos, event) {
        var edge, vertex;
        console.log("new event", {
            event
        });
        vertex = Step.matchVertex(talos);
        if (talos.ended) {
            return talos;
        }
        edge = Step.matchEdge(vertex, talos, event);
        if (talos.ended) {
            return talos;
        }
        Step.run(edge, talos, event);
        if (talos.ended) {
            return talos;
        }
        Step.move(edge, talos, event);
        return talos;
    },
    generator: function*() {
        while(true){
            Step.step(this, (yield));
            if (this.ended) {
                return this;
            }
        }
    }
};
start = function(machine) {
    var talos;
    talos = Talos.make(machine);
    talos.generator = Step.generator.bind(talos);
    talos.cycle = talos.generator();
    talos.cycle.next();
    return talos;
};
run = generic({
    name: "talos: run",
    default: function() {
        for(var _len = arguments.length, args = new Array(_len), _key = 0; _key < _len; _key++){
            args[_key] = arguments[_key];
        }
        throw new Error(`talos run: input is malformed ${JSON.stringify(args)}`);
    }
});
generic(run, Type.isObject, function(machine) {
    var talos;
    talos = start(machine);
    return run(talos, talos.context);
});
generic(run, Talos.isType, function(talos) {
    return run(talos, talos.context);
});
generic(run, Type.isObject, Type.isAny, function(machine, context) {
    var talos;
    talos = start(machine);
    return run(talos, context);
});
generic(run, Talos.isType, Type.isAny, function(talos, context) {
    talos.context = context;
    while(true){
        talos.cycle.next(talos.context);
        console.log("event processed", talos.state, talos.context);
        if (talos.ended) {
            break;
        }
    }
    if (talos.error != null) {
        console.error(talos.error);
    }
    return talos;
});
generic(run, Type.isObject, Type.isAny, Type.isIterable, function(machine, context, events) {
    var talos;
    talos = start(machine);
    return run(talos, context, events);
});
generic(run, Talos.isType, Type.isAny, Type.isIterable, function(talos, context, events) {
    var event;
    talos.context = context;
    for (event of events){
        talos.cycle.next(event);
        console.log("event processed", talos.state, talos.context);
        if (talos.ended) {
            break;
        }
    }
    if (talos.error != null) {
        console.error(talos.error);
    }
    return talos;
});
build = function(talos) {
    return function() {
        for(var _len = arguments.length, args = new Array(_len), _key = 0; _key < _len; _key++){
            args[_key] = arguments[_key];
        }
        return run(talos, ...args);
    };
};
pipe = function(fx) {
    var machine;
    machine = Machine.make(fx);
    return function(context) {
        var talos;
        talos = start(machine);
        run(talos, context);
        return talos.context;
    };
};
export { Step, start, run, build, pipe }; //# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsic3JjL3N5bmMuY29mZmVlIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLElBQUEsSUFBQSxFQUFBLEtBQUEsRUFBQSxJQUFBLEVBQUEsR0FBQSxFQUFBOztBQUFBLE9BQUE7RUFBUyxPQUFUO0NBQUEsTUFBQTs7QUFDQSxPQUFPLENBQUEsUUFBUCxNQUFBOztBQUNBLE9BQU8sR0FBUCxNQUFBOztBQUNBLE9BQUE7RUFBUyxPQUFUO0NBQUEsTUFBQTs7QUFDQSxPQUFBO0VBQVMsS0FBVDtDQUFBLE1BQUE7O0FBR0EsSUFBQSxHQUNFO0VBQUEsV0FBQSxFQUFhLFFBQUEsQ0FBRSxLQUFGLENBQUE7QUFDZixRQUFBO0lBQUksTUFBQSxHQUFTLEtBQUssQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFFLEtBQUssQ0FBQyxLQUFSO0lBQzVCLElBQUksY0FBSjtNQUNFLEtBQUssQ0FBQyxLQUFOLENBQVksSUFBSSxLQUFKLENBQVUscUNBQVYsQ0FBWixFQURGOztXQUVBO0VBSlcsQ0FBYjtFQU1BLFNBQUEsRUFBVyxRQUFBLENBQUUsTUFBRixFQUFVLEtBQVYsRUFBaUIsS0FBakIsQ0FBQTtBQUNiLFFBQUEsSUFBQSxFQUFBLEtBQUEsRUFBQSxDQUFBLEVBQUEsR0FBQSxFQUFBO0FBQUk7SUFBQSxLQUFBLHFDQUFBOztBQUNFO1FBQ0UsSUFBRyxDQUFFLElBQUksQ0FBQyxJQUFMLENBQVUsS0FBVixFQUFpQixLQUFqQixDQUFGLENBQUEsS0FBOEIsSUFBakM7QUFDRSxpQkFBTyxLQURUO1NBREY7T0FHQSxjQUFBO1FBQU07QUFDSixlQUFPLEtBQUssQ0FBQyxLQUFOLENBQVksS0FBWixFQURUOztJQUpGO1dBTUEsS0FBSyxDQUFDLEtBQU4sQ0FBWSxJQUFJLEtBQUosQ0FBVSw0QkFBVixDQUFaO0VBUFMsQ0FOWDtFQWVBLEdBQUEsRUFBSyxRQUFBLENBQUUsSUFBRixFQUFRLEtBQVIsRUFBZSxLQUFmLENBQUE7QUFD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T0FBTyxDQUFDLEdBQVIsQ0FBWSxpQkFBWixFQUErQixLQUFLLENBQUMsS0FBckMsRUFBNEMsS0FBSyxDQUFDLE9BQWxEO0lBQ0EsSUFBUyxLQUFLLENBQUMsS0FBZjtBQUFBLFlBQUE7O0VBSEY7RUFJQSxJQUFHLG1CQUFIO0lBQ0UsT0FBTyxDQUFDLEtBQVIsQ0FBYyxLQUFLLENBQUMsS0FBcEIsRUFERjs7U0FFQTtBQVJzRCxDQUF4RDs7QUFZQSxLQUFBLEdBQVEsUUFBQSxDQUFFLEtBQUYsQ0FBQTtTQUNOLFFBQUEsQ0FBQSxHQUFFLElBQUYsQ0FBQTtXQUFlLEdBQUEsQ0FBSSxLQUFKLEVBQVcsR0FBQSxJQUFYO0VBQWY7QUFETTs7QUFHUixJQUFBLEdBQU8sUUFBQSxDQUFFLEVBQUYsQ0FBQTtBQUNQLE1BQUE7RUFBRSxPQUFBLEdBQVUsT0FBTyxDQUFDLElBQVIsQ0FBYSxFQUFiO1NBQ1YsUUFBQSxDQUFFLE9BQUYsQ0FBQTtBQUNGLFFBQUE7SUFBSSxLQUFBLEdBQVEsS0FBQSxDQUFNLE9BQU47SUFDUixHQUFBLENBQUksS0FBSixFQUFXLE9BQVg7V0FDQSxLQUFLLENBQUM7RUFIUjtBQUZLOztBQVFQLE9BQUE7RUFDRSxJQURGO0VBRUUsS0FGRjtFQUdFLEdBSEY7RUFJRSxLQUpGO0VBS0UsSUFMRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGdlbmVyaWMgfSBmcm9tIFwiQGRhc2hraXRlL2pveS9nZW5lcmljXCJcbmltcG9ydCAqIGFzIFR5cGUgZnJvbSBcIkBkYXNoa2l0ZS9qb3kvdHlwZVwiXG5pbXBvcnQgbG9nIGZyb20gXCJAZGFzaGtpdGUva2Fpa29cIlxuaW1wb3J0IHsgTWFjaGluZSB9IGZyb20gXCIuL21hY2hpbmVcIlxuaW1wb3J0IHsgVGFsb3MgfSBmcm9tIFwiLi90YWxvc1wiXG5cblxuU3RlcCA9XG4gIG1hdGNoVmVydGV4OiAoIHRhbG9zICkgLT5cbiAgICB2ZXJ0ZXggPSB0YWxvcy5tYWNoaW5lLmdyYXBoWyB0YWxvcy5zdGF0ZSBdXG4gICAgaWYgIXZlcnRleD9cbiAgICAgIHRhbG9zLmNhdGNoIG5ldyBFcnJvciBcInRhbG9zIHN0YXRlIGlzIG5vdCBpbiBtYWNoaW5lIGdyYXBoXCJcbiAgICB2ZXJ0ZXhcblxuICBtYXRjaEVkZ2U6ICggdmVydGV4LCB0YWxvcywgZXZlbnQgKSAtPlxuICAgIGZvciBlZGdlIGluIHZlcnRleC5lZGdlc1xuICAgICAgdHJ5XG4gICAgICAgIGlmICggZWRnZS53aGVuIHRhbG9zLCBldmVudCApID09IHRydWVcbiAgICAgICAgICByZXR1cm4gZWRnZVxuICAgICAgY2F0Y2ggZXJyb3JcbiAgICAgICAgcmV0dXJuIHRhbG9zLmNhdGNoIGVycm9yXG4gICAgdGFsb3MuY2F0Y2ggbmV3IEVycm9yIFwibm8gbWF0Y2hpbmcgd2hlbiBjb25kaXRpb25cIlxuXG4gIHJ1bjogKCBlZGdlLCB0YWxvcywgZXZlbnQgKSAtPlxuICAgIGlmIGVkZ2UucnVuP1xuICAgICAgdHJ5XG4gICAgICAgIGVkZ2UucnVuIHRhbG9zLCBldmVudFxuICAgICAgY2F0Y2ggZXJyb3JcbiAgICAgICAgdGFsb3MuY2F0Y2ggZXJyb3JcblxuICBtb3ZlOiAoIGVkZ2UsIHRhbG9zLCBldmVudCApIC0+XG4gICAgdHJ5XG4gICAgICBlZGdlLm1vdmUgdGFsb3MsIGV2ZW50XG4gICAgY2F0Y2ggZXJyb3JcbiAgICAgIHRhbG9zLmNhdGNoIGVycm9yXG5cbiAgc3RlcDogKCB0YWxvcywgZXZlbnQgKSAtPlxuICAgIGNvbnNvbGUubG9nIFwibmV3IGV2ZW50XCIsIHsgZXZlbnQgfVxuICAgIHZlcnRleCA9IFN0ZXAubWF0Y2hWZXJ0ZXggdGFsb3NcbiAgICByZXR1cm4gdGFsb3MgaWYgdGFsb3MuZW5kZWRcblxuICAgIGVkZ2UgPSBTdGVwLm1hdGNoRWRnZSB2ZXJ0ZXgsIHRhbG9zLCBldmVudFxuICAgIHJldHVybiB0YWxvcyBpZiB0YWxvcy5lbmRlZFxuXG4gICAgU3RlcC5ydW4gZWRnZSwgdGFsb3MsIGV2ZW50XG4gICAgcmV0dXJuIHRhbG9zIGlmIHRhbG9zLmVuZGVkXG5cbiAgICBTdGVwLm1vdmUgZWRnZSwgdGFsb3MsIGV2ZW50XG4gICAgdGFsb3NcblxuICBnZW5lcmF0b3I6IC0+XG4gICAgbG9vcFxuICAgICAgU3RlcC5zdGVwIEAsIHlpZWxkXG4gICAgICByZXR1cm4gQCBpZiBAZW5kZWRcblxuXG5zdGFydCA9ICggbWFjaGluZSApIC0+XG4gIHRhbG9zID0gVGFsb3MubWFrZSBtYWNoaW5lXG4gIHRhbG9zLmdlbmVyYXRvciA9IFN0ZXAuZ2VuZXJhdG9yLmJpbmQgdGFsb3NcbiAgdGFsb3MuY3ljbGUgPSB0YWxvcy5nZW5lcmF0b3IoKVxuICB0YWxvcy5jeWNsZS5uZXh0KClcbiAgdGFsb3NcblxuXG5ydW4gPSBnZW5lcmljIFxuICBuYW1lOiBcInRhbG9zOiBydW5cIlxuICBkZWZhdWx0OiAoIGFyZ3MuLi4gKSAtPiBcbiAgICB0aHJvdyBuZXcgRXJyb3IgXCJ0YWxvcyBydW46IGlucHV0IGlzIG1hbGZvcm1lZCAjeyBKU09OLnN0cmluZ2lmeSBhcmdzIH1cIlxuXG5nZW5lcmljIHJ1biwgVHlwZS5pc09iamVjdCwgKCBtYWNoaW5lICkgLT5cbiAgdGFsb3MgPSBzdGFydCBtYWNoaW5lXG4gIHJ1biB0YWxvcywgdGFsb3MuY29udGV4dFxuXG5nZW5lcmljIHJ1biwgVGFsb3MuaXNUeXBlLCAoIHRhbG9zICkgLT5cbiAgcnVuIHRhbG9zLCB0YWxvcy5jb250ZXh0XG5cbmdlbmVyaWMgcnVuLCBUeXBlLmlzT2JqZWN0LCBUeXBlLmlzQW55LCAoIG1hY2hpbmUsIGNvbnRleHQgKSAtPlxuICB0YWxvcyA9IHN0YXJ0IG1hY2hpbmVcbiAgcnVuIHRhbG9zLCBjb250ZXh0XG5cbmdlbmVyaWMgcnVuLCBUYWxvcy5pc1R5cGUsIFR5cGUuaXNBbnksICggdGFsb3MsIGNvbnRleHQgKSAtPlxuICB0YWxvcy5jb250ZXh0ID0gY29udGV4dFxuICBsb29wXG4gICAgdGFsb3MuY3ljbGUubmV4dCB0YWxvcy5jb250ZXh0XG4gICAgY29uc29sZS5sb2cgXCJldmVudCBwcm9jZXNzZWRcIiwgdGFsb3Muc3RhdGUsIHRhbG9zLmNvbnRleHRcbiAgICBicmVhayBpZiB0YWxvcy5lbmRlZFxuICBpZiB0YWxvcy5lcnJvcj9cbiAgICBjb25zb2xlLmVycm9yIHRhbG9zLmVycm9yXG4gIHRhbG9zXG5cbmdlbmVyaWMgcnVuLCBUeXBlLmlzT2JqZWN0LCBUeXBlLmlzQW55LCBUeXBlLmlzSXRlcmFibGUsICggbWFjaGluZSwgY29udGV4dCwgZXZlbnRzICkgLT5cbiAgdGFsb3MgPSBzdGFydCBtYWNoaW5lXG4gIHJ1biB0YWxvcywgY29udGV4dCwgZXZlbnRzXG5cbmdlbmVyaWMgcnVuLCBUYWxvcy5pc1R5cGUsIFR5cGUuaXNBbnksIFR5cGUuaXNJdGVyYWJsZSwgKCB0YWxvcywgY29udGV4dCwgZXZlbnRzICkgLT5cbiAgdGFsb3MuY29udGV4dCA9IGNvbnRleHRcbiAgZm9yIGV2ZW50IGZyb20gZXZlbnRzXG4gICAgdGFsb3MuY3ljbGUubmV4dCBldmVudFxuICAgIGNvbnNvbGUubG9nIFwiZXZlbnQgcHJvY2Vzc2VkXCIsIHRhbG9zLnN0YXRlLCB0YWxvcy5jb250ZXh0XG4gICAgYnJlYWsgaWYgdGFsb3MuZW5kZWRcbiAgaWYgdGFsb3MuZXJyb3I/XG4gICAgY29uc29sZS5lcnJvciB0YWxvcy5lcnJvclxuICB0YWxvc1xuXG5cblxuYnVpbGQgPSAoIHRhbG9zICkgLT5cbiAgKCBhcmdzLi4uICkgLT4gcnVuIHRhbG9zLCBhcmdzLi4uXG5cbnBpcGUgPSAoIGZ4ICkgLT5cbiAgbWFjaGluZSA9IE1hY2hpbmUubWFrZSBmeFxuICAoIGNvbnRleHQgKSAtPiBcbiAgICB0YWxvcyA9IHN0YXJ0IG1hY2hpbmVcbiAgICBydW4gdGFsb3MsIGNvbnRleHRcbiAgICB0YWxvcy5jb250ZXh0XG5cblxuZXhwb3J0IHtcbiAgU3RlcCAgXG4gIHN0YXJ0XG4gIHJ1blxuICBidWlsZFxuICBwaXBlXG59Il19
 //# sourceURL=src/sync.coffee

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNyYy9zeW5jLmNvZmZlZSJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBnZW5lcmljIH0gZnJvbSBcIkBkYXNoa2l0ZS9qb3kvZ2VuZXJpY1wiXG5pbXBvcnQgKiBhcyBUeXBlIGZyb20gXCJAZGFzaGtpdGUvam95L3R5cGVcIlxuaW1wb3J0IGxvZyBmcm9tIFwiQGRhc2hraXRlL2thaWtvXCJcbmltcG9ydCB7IE1hY2hpbmUgfSBmcm9tIFwiLi9tYWNoaW5lXCJcbmltcG9ydCB7IFRhbG9zIH0gZnJvbSBcIi4vdGFsb3NcIlxuXG5cblN0ZXAgPVxuICBtYXRjaFZlcnRleDogKCB0YWxvcyApIC0+XG4gICAgdmVydGV4ID0gdGFsb3MubWFjaGluZS5ncmFwaFsgdGFsb3Muc3RhdGUgXVxuICAgIGlmICF2ZXJ0ZXg/XG4gICAgICB0YWxvcy5jYXRjaCBuZXcgRXJyb3IgXCJ0YWxvcyBzdGF0ZSBpcyBub3QgaW4gbWFjaGluZSBncmFwaFwiXG4gICAgdmVydGV4XG5cbiAgbWF0Y2hFZGdlOiAoIHZlcnRleCwgdGFsb3MsIGV2ZW50ICkgLT5cbiAgICBmb3IgZWRnZSBpbiB2ZXJ0ZXguZWRnZXNcbiAgICAgIHRyeVxuICAgICAgICBpZiAoIGVkZ2Uud2hlbiB0YWxvcywgZXZlbnQgKSA9PSB0cnVlXG4gICAgICAgICAgcmV0dXJuIGVkZ2VcbiAgICAgIGNhdGNoIGVycm9yXG4gICAgICAgIHJldHVybiB0YWxvcy5jYXRjaCBlcnJvclxuICAgIHRhbG9zLmNhdGNoIG5ldyBFcnJvciBcIm5vIG1hdGNoaW5nIHdoZW4gY29uZGl0aW9uXCJcblxuICBydW46ICggZWRnZSwgdGFsb3MsIGV2ZW50ICkgLT5cbiAgICBpZiBlZGdlLnJ1bj9cbiAgICAgIHRyeVxuICAgICAgICBlZGdlLnJ1biB0YWxvcywgZXZlbnRcbiAgICAgIGNhdGNoIGVycm9yXG4gICAgICAgIHRhbG9zLmNhdGNoIGVycm9yXG5cbiAgbW92ZTogKCBlZGdlLCB0YWxvcywgZXZlbnQgKSAtPlxuICAgIHRyeVxuICAgICAgZWRnZS5tb3ZlIHRhbG9zLCBldmVudFxuICAgIGNhdGNoIGVycm9yXG4gICAgICB0YWxvcy5jYXRjaCBlcnJvclxuXG4gIHN0ZXA6ICggdGFsb3MsIGV2ZW50ICkgLT5cbiAgICBjb25zb2xlLmxvZyBcIm5ldyBldmVudFwiLCB7IGV2ZW50IH1cbiAgICB2ZXJ0ZXggPSBTdGVwLm1hdGNoVmVydGV4IHRhbG9zXG4gICAgcmV0dXJuIHRhbG9zIGlmIHRhbG9zLmVuZGVkXG5cbiAgICBlZGdlID0gU3RlcC5tYXRjaEVkZ2UgdmVydGV4LCB0YWxvcywgZXZlbnRcbiAgICByZXR1cm4gdGFsb3MgaWYgdGFsb3MuZW5kZWRcblxuICAgIFN0ZXAucnVuIGVkZ2UsIHRhbG9zLCBldmVudFxuICAgIHJldHVybiB0YWxvcyBpZiB0YWxvcy5lbmRlZFxuXG4gICAgU3RlcC5tb3ZlIGVkZ2UsIHRhbG9zLCBldmVudFxuICAgIHRhbG9zXG5cbiAgZ2VuZXJhdG9yOiAtPlxuICAgIGxvb3BcbiAgICAgIFN0ZXAuc3RlcCBALCB5aWVsZFxuICAgICAgcmV0dXJuIEAgaWYgQGVuZGVkXG5cblxuc3RhcnQgPSAoIG1hY2hpbmUgKSAtPlxuICB0YWxvcyA9IFRhbG9zLm1ha2UgbWFjaGluZVxuICB0YWxvcy5nZW5lcmF0b3IgPSBTdGVwLmdlbmVyYXRvci5iaW5kIHRhbG9zXG4gIHRhbG9zLmN5Y2xlID0gdGFsb3MuZ2VuZXJhdG9yKClcbiAgdGFsb3MuY3ljbGUubmV4dCgpXG4gIHRhbG9zXG5cblxucnVuID0gZ2VuZXJpYyBcbiAgbmFtZTogXCJ0YWxvczogcnVuXCJcbiAgZGVmYXVsdDogKCBhcmdzLi4uICkgLT4gXG4gICAgdGhyb3cgbmV3IEVycm9yIFwidGFsb3MgcnVuOiBpbnB1dCBpcyBtYWxmb3JtZWQgI3sgSlNPTi5zdHJpbmdpZnkgYXJncyB9XCJcblxuZ2VuZXJpYyBydW4sIFR5cGUuaXNPYmplY3QsICggbWFjaGluZSApIC0+XG4gIHRhbG9zID0gc3RhcnQgbWFjaGluZVxuICBydW4gdGFsb3MsIHRhbG9zLmNvbnRleHRcblxuZ2VuZXJpYyBydW4sIFRhbG9zLmlzVHlwZSwgKCB0YWxvcyApIC0+XG4gIHJ1biB0YWxvcywgdGFsb3MuY29udGV4dFxuXG5nZW5lcmljIHJ1biwgVHlwZS5pc09iamVjdCwgVHlwZS5pc0FueSwgKCBtYWNoaW5lLCBjb250ZXh0ICkgLT5cbiAgdGFsb3MgPSBzdGFydCBtYWNoaW5lXG4gIHJ1biB0YWxvcywgY29udGV4dFxuXG5nZW5lcmljIHJ1biwgVGFsb3MuaXNUeXBlLCBUeXBlLmlzQW55LCAoIHRhbG9zLCBjb250ZXh0ICkgLT5cbiAgdGFsb3MuY29udGV4dCA9IGNvbnRleHRcbiAgbG9vcFxuICAgIHRhbG9zLmN5Y2xlLm5leHQgdGFsb3MuY29udGV4dFxuICAgIGNvbnNvbGUubG9nIFwiZXZlbnQgcHJvY2Vzc2VkXCIsIHRhbG9zLnN0YXRlLCB0YWxvcy5jb250ZXh0XG4gICAgYnJlYWsgaWYgdGFsb3MuZW5kZWRcbiAgaWYgdGFsb3MuZXJyb3I/XG4gICAgY29uc29sZS5lcnJvciB0YWxvcy5lcnJvclxuICB0YWxvc1xuXG5nZW5lcmljIHJ1biwgVHlwZS5pc09iamVjdCwgVHlwZS5pc0FueSwgVHlwZS5pc0l0ZXJhYmxlLCAoIG1hY2hpbmUsIGNvbnRleHQsIGV2ZW50cyApIC0+XG4gIHRhbG9zID0gc3RhcnQgbWFjaGluZVxuICBydW4gdGFsb3MsIGNvbnRleHQsIGV2ZW50c1xuXG5nZW5lcmljIHJ1biwgVGFsb3MuaXNUeXBlLCBUeXBlLmlzQW55LCBUeXBlLmlzSXRlcmFibGUsICggdGFsb3MsIGNvbnRleHQsIGV2ZW50cyApIC0+XG4gIHRhbG9zLmNvbnRleHQgPSBjb250ZXh0XG4gIGZvciBldmVudCBmcm9tIGV2ZW50c1xuICAgIHRhbG9zLmN5Y2xlLm5leHQgZXZlbnRcbiAgICBjb25zb2xlLmxvZyBcImV2ZW50IHByb2Nlc3NlZFwiLCB0YWxvcy5zdGF0ZSwgdGFsb3MuY29udGV4dFxuICAgIGJyZWFrIGlmIHRhbG9zLmVuZGVkXG4gIGlmIHRhbG9zLmVycm9yP1xuICAgIGNvbnNvbGUuZXJyb3IgdGFsb3MuZXJyb3JcbiAgdGFsb3NcblxuXG5cbmJ1aWxkID0gKCB0YWxvcyApIC0+XG4gICggYXJncy4uLiApIC0+IHJ1biB0YWxvcywgYXJncy4uLlxuXG5waXBlID0gKCBmeCApIC0+XG4gIG1hY2hpbmUgPSBNYWNoaW5lLm1ha2UgZnhcbiAgKCBjb250ZXh0ICkgLT4gXG4gICAgdGFsb3MgPSBzdGFydCBtYWNoaW5lXG4gICAgcnVuIHRhbG9zLCBjb250ZXh0XG4gICAgdGFsb3MuY29udGV4dFxuXG5cbmV4cG9ydCB7XG4gIFN0ZXAgIFxuICBzdGFydFxuICBydW5cbiAgYnVpbGRcbiAgcGlwZVxufSJdLCJuYW1lcyI6WyJTdGVwIiwiYnVpbGQiLCJwaXBlIiwicnVuIiwic3RhcnQiLCJnZW5lcmljIiwiVHlwZSIsImxvZyIsIk1hY2hpbmUiLCJUYWxvcyIsIm1hdGNoVmVydGV4IiwidGFsb3MiLCJ2ZXJ0ZXgiLCJtYWNoaW5lIiwiZ3JhcGgiLCJzdGF0ZSIsImNhdGNoIiwiRXJyb3IiLCJtYXRjaEVkZ2UiLCJldmVudCIsImVkZ2UiLCJlcnJvciIsImkiLCJsZW4iLCJyZWYiLCJlZGdlcyIsImxlbmd0aCIsIndoZW4iLCJlcnJvcjEiLCJtb3ZlIiwic3RlcCIsImNvbnNvbGUiLCJlbmRlZCIsImdlbmVyYXRvciIsIm1ha2UiLCJiaW5kIiwiY3ljbGUiLCJuZXh0IiwibmFtZSIsImRlZmF1bHQiLCJhcmdzIiwiSlNPTiIsInN0cmluZ2lmeSIsImlzT2JqZWN0IiwiY29udGV4dCIsImlzVHlwZSIsImlzQW55IiwiaXNJdGVyYWJsZSIsImV2ZW50cyIsImZ4Il0sIm1hcHBpbmdzIjoiQUFBQSxJQUFBQSxNQUFBQyxPQUFBQyxNQUFBQyxLQUFBQztBQUFBLFNBQVNDLE9BQVQsUUFBQSx3QkFBQTtBQUNBLFlBQU9DLFVBQVAscUJBQUE7QUFDQSxPQUFPQyxTQUFQLGtCQUFBO0FBQ0EsU0FBU0MsT0FBVCxRQUFBLFlBQUE7QUFD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